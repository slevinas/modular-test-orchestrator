name: CI - Test Target Smoke

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    smoke-tests:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              working-directory: ${{ github.workspace }}
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Build and start fastApi test target
              working-directory: ${{ github.workspace }}/docker
              run: |
                  docker compose -f docker-compose.test-target.yml up -d --build
                  # give it a few seconds to boot
                  sleep 10

            - name: Call Pytest (Run smoke tests)
              working-directory: ${{ github.workspace }}
              env:
                  TEST_TARGET_BASE_URL: http://localhost:8080
              run: |
                  pytest -m smoke -vv

            - name: Tear down test target
              if: always()
              working-directory: ${{ github.workspace }}/docker
              run: |
                  docker compose -f docker-compose.test-target.yml down
